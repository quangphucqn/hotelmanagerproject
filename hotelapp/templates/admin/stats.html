{% extends 'admin/base.html' %}

{% block body %}
<h1 class="text-center text-danger">THỐNG KÊ DOANH THU THEO LOẠI PHÒNG</h1>

<div class="row">
    <div class="col-md-5 col-xs-12">
        <table class="table">
            <tr>
                <th>LOẠI PHÒNG</th>
                <th>DOANH THU</th>
                <th>SỐ LƯỢT THUÊ</th>
                <th>TỶ LỆ</th>
            </tr>
            {% if room_type_stats %}
                {% for rt in room_type_stats %}
                <tr>
                    <td>{{ rt[0] }}</td>
                    <td>{{ "{:,.1f}".format(rt[1]) }} VND</td>
                    <td>{{ rt[2] }}</td>
                    <td>{{ "{:.2f}".format(rt[3]) }}%</td>
                </tr>
                {% endfor %}
            {% else %}
                <tr><td colspan="4">Không có dữ liệu để hiển thị</td></tr>
            {% endif %}
        </table>
    </div>

    <div class="col-md-5 col-xs-12">
        <form method="get">
            <div class="form-group">
                <input type="date" class="form-control" name="from_date" />
            </div>
            <br>
            <div class="form-group">
                <input type="date" class="form-control" name="to_date" />
            </div>
            <input type="submit" value="Thống kê" class="btn btn-info">
        </form>
        <canvas id="roomChartId"></canvas>
    </div>
</div>

<div class="row">
    <div class="col-md-5 col-xs-12">
        <table class="table">
            <tr>
                <th>THÁNG</th>
                <th>DOANH THU</th>
            </tr>
            {% for s in monthly_revenue_stats %}
            <tr>
                <td>{{ s[0] }}</td>
                <td>{{ "{:,.1f}".format(s[1]) }} VND</td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <div class="col-md-5 col-xs-12">
        <form method="get">
            <div class="form-group">
                <input type="number" min="2000" name="year" class="form-control" placeholder="Nhập năm..." />
            </div>
            <input type="submit" value="Thống kê" class="btn btn-danger" />
        </form>
        <canvas id="roomMonthChartId"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let labels = [], labels2 = [];
    let data = [], data2 = [];
    let colors = [], colors2 = [];
    let borderColors = [], borderColors2 = [];
    let r, g, b;

    // Biểu đồ loại phòng
    {% for s in room_type_stats %}
        labels.push('{{ s.room_type_name }}'); // Loại phòng
        data.push({{ s.total_revenue }}); // Doanh thu

        r = parseInt(Math.random() * 255);
        g = parseInt(Math.random() * 255);
        b = parseInt(Math.random() * 255);

        colors.push(`rgba(${r},${g},${b},0.2)`);
        borderColors.push(`rgba(${r},${g},${b},1)`);
    {% endfor %}

    // Biểu đồ doanh thu theo tháng
    {% for s in monthly_revenue_stats %}
        labels2.push('Tháng {{ s.month }}');
        data2.push({{ s.total_revenue }});

        r = parseInt(Math.random() * 255);
        g = parseInt(Math.random() * 255);
        b = parseInt(Math.random() * 255);

        colors2.push(`rgba(${r},${g},${b},0.2)`);
        borderColors2.push(`rgba(${r},${g},${b},1)`);
    {% endfor %}

    window.onload = function () {
        const ctx = document.getElementById('roomChartId').getContext('2d');
        const ctx2 = document.getElementById('roomMonthChartId').getContext('2d');

        // Biểu đồ doanh thu theo loại phòng
        loadChart(ctx, labels, data, 'bar', colors, borderColors, 'Doanh thu theo loại phòng');

        // Biểu đồ doanh thu theo tháng
        loadChart(ctx2, labels2, data2, 'line', colors2, borderColors2, 'Doanh thu theo tháng');
    }

    function loadChart(ctx, labels, data, type, colors, borderColors, label) {
        const myChart = new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    backgroundColor: colors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
</script>

{% endblock %}
